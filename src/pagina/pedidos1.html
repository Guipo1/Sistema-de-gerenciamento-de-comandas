<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seus produtos</title>
    <div id="imagem"></div>
    <style>
      #imagem {
        display: flex;
        justify-content: center;
        align-items: center;
        max-width: 1%;
        height: auto;
        margin: 10%;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #dddddd;
        color: #cecbba;
      }
      h1 {
        color: #0056b3;
        text-align: center;
        margin-bottom: 30px;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .categoria-section {
        margin-bottom: 40px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
      }
      .categoria-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .categoria-title {
        color: #28a745;
        font-size: 1.8em;
        margin-bottom: 20px;
        border-left: 5px solid #28a745;
        padding-left: 10px;
      }
      .produto-card {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .produto-card h3 {
        margin: 0 0 5px 0;
        color: #007bff;
        font-size: 1.2em;
      }
      .produto-card p {
        margin: 0;
        font-size: 0.95em;
        line-height: 1.4;
      }
      .loading-message {
        text-align: center;
        font-size: 1.1em;
        color: #666;
      }
      .error-message {
        text-align: center;
        font-size: 1.1em;
        color: #dc3545;
      }
      .botao-alterar {
        background-color: green;
        color: white;
      }
      .botao-deletar {
        background-color: red;
        color: white;
      }
      .nomeProdutos,
      .ingredientes,
      .valor {
        color: black;
      }
      #criarProduto {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #botao {
        display: flex;
        flex-direction: column;
        border: 2px solid black;
        justify-content: center;
        align-items: center;
        right: 50%;
        position: absolute;
        width: 10%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="container" id="container">
      <h1>Seus Produtos</h1>
      <div id="produtos-container">
        <p class="loading-message">Carregando produtos...</p>
      </div>
    </div>
    <div id="botao">
      <button id="criarProduto" onclick="criarProduto()">
        Criar um novo produto
      </button>
    </div>
    <script>
      const url = window.location.href;
      const partesDaUrl = url.split("/");
      const ultimoElemento = partesDaUrl.pop();
      const token = localStorage.getItem("token");
      const API_URL = `/buscar-produtos/${ultimoElemento}`; // URL da sua API que retorna todos os produtos

      const produtosContainer = document.getElementById("produtos-container");

      /**
       * Busca todos os produtos da API e os agrupa por categoria.
       * @returns {Object} Um objeto onde as chaves são os nomes das categorias e os valores são arrays de produtos.
       */
      async function getAndGroupProductsByCategory() {
        try {
          const response = await fetch(API_URL);

          if (!response.ok) {
            throw new Error(`Erro HTTP! Status: ${response.status}`);
          }

          const produtos = await response.json(); // Recebe o array plano de produtos
          alert(JSON.stringify(produtos));
          document.getElementById(
            "imagem"
          ).innerHTML += `<img src="/imagem/${produtos.nomeImagem}" id="imagem">`;
          if (produtos.produtos.length === 0) {
            return {}; // Retorna um objeto vazio se não houver produtos
          }

          const produtosPorCategoria = {};

          // Agrupa os produtos por tipoProduto
          produtos.produtos.forEach((produto) => {
            const categoria = produto.tipoProduto.toLowerCase(); // Garante consistência
            if (!produtosPorCategoria[categoria]) {
              produtosPorCategoria[categoria] = [];
            }
            produtosPorCategoria[categoria].push(produto);
          });

          return produtosPorCategoria;
        } catch (error) {
          console.error("Erro ao buscar e agrupar produtos:", error);
          throw error; // Rejoga o erro para ser tratado pela função chamadora
        }
      }

      /**
       * Renderiza os produtos agrupados na interface do usuário.
       * @param {Object} produtosAgrupados - Objeto com produtos agrupados por categoria.
       */
      function renderProducts(produtosAgrupados) {
        produtosContainer.innerHTML = ""; // Limpa qualquer conteúdo anterior

        const categoriasOrdenadas = Object.keys(produtosAgrupados).sort(); // Ordena as categorias alfabeticamente

        if (categoriasOrdenadas.length === 0) {
          produtosContainer.innerHTML =
            '<p class="loading-message">Nenhum produto encontrado.</p>';
          return;
        }

        categoriasOrdenadas.forEach((categoriaNome) => {
          const produtosDaCategoria = produtosAgrupados[categoriaNome];

          const categoriaSection = document.createElement("div");
          categoriaSection.classList.add("categoria-section");
          categoriaSection.id = `${categoriaNome}`;
          const categoriaTitle = document.createElement("h2");
          categoriaTitle.classList.add("categoria-title");
          categoriaTitle.textContent =
            categoriaNome.charAt(0).toUpperCase() + categoriaNome.slice(1);
          categoriaSection.appendChild(categoriaTitle);

          produtosDaCategoria.forEach((produto) => {
            const produtoCard = document.createElement("div");
            produtoCard.classList.add("produto-card");
            produtoCard.innerHTML = `
                         <div class="cardProdutos" id="${produto._id}">

          <h2 class="nomeProdutos">${produto.nomeProduto}</h2>
          <div class="ingredientes">${produto.ingredientes}</p>
          <div class="valor">R$ ${produto.valor}</div>
             <button onclick="alterar('${produto._id}')" class="botao-alterar">alterar</button>
          <button class="botao-deletar" onclick="deletar('${produto._id}')">Deletar</button>
        </div>
                    `;
            categoriaSection.appendChild(produtoCard);
          });

          produtosContainer.appendChild(categoriaSection);
        });
      }

      // --- Ponto de Entrada da Aplicação ---
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const produtosAgrupados = await getAndGroupProductsByCategory();
          renderProducts(produtosAgrupados);
        } catch (error) {
          produtosContainer.innerHTML = `<p class="error-message">Não foi possível carregar os produtos. Por favor, tente novamente mais tarde. (${error.message})</p>`;
        }
      });
      function criarProduto() {
        document.getElementById("container").innerHTML += `
      <div id="criar-produto">
      <h1>Digie o novo produto</h1>
      <input type="text" id="nome" placeholder="nome do produto">
      <input type="text" id="categoria" placeholder="categoria do produto">
      <input type="text" id="ingredientes" placeholder="ingredientes do produto">
      <input type="number" id="valor" placeholder="valor do produto">
      <button id="apagar" onclick="apagar()">Apagar</button>
      <button id="enviar" onclick="enviar()">Enviar</button>
      </div>
      `;
      }
      function apagar() {
        document.getElementById("criar-produto").remove();
      }
      function enviar() {
        const nomeProduto = document.getElementById("nome").value.trim();
        const categoiaProduto = document
          .getElementById("categoria")
          .value.trim();
        const ingredientesProduto = document
          .getElementById("ingredientes")
          .value.trim();
        const valorProduto = document.getElementById("valor").value.trim();
        const produto = {
          nomeProduto: nomeProduto,
          ingredientes: ingredientesProduto,
          valor: valorProduto,
          tipoProduto: categoiaProduto,
          nomeEstabelecimento: ultimoElemento,
        };

        fetch(`/produto/${ultimoElemento}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(produto),
        })
          .then((data) => data.json())
          .then((produto) => {
            console.log(produto.produto.tipoProduto);
            const adicionarProduto = document.getElementById(
              produto.produto.tipoProduto
            );
            if (adicionarProduto) {
              adicionarProduto.innerHTML += ` <div class="cardProdutos" id="${produto._id}">

          <h2 class="nomeProdutos">${produto.nomeProduto}</h2>
          <div class="ingredientes">${produto.ingredientes}</p>
          <div class="valor">R$ ${produto.valor}</div>
             <button onclick="alterar('${produto._id}')" class="botao-alterar">alterar</button>
          <button class="botao-deletar" onclick="deletar('${produto._id}')">Deletar</button>
        </div>`;
              const criarProduto = document.getElementById("criar-produto");
              criarProduto.remove();
            } else {
              const container = document.getElementById("container");
              container.innerHTML += `
        <div class="categoria-section">
          <h2 class="categoria-title">${produto.produto.tipoProduto}</h2>
          <div class="cardProdutos" id="${produto.produto._id}">

          <h2 class="nomeProdutos">${produto.produto.nomeProduto}</h2>
          <div class="ingredientes">${produto.produto.ingredientes}</p>
          <div class="valor">R$ ${produto.produto.valor}</div>
             <button onclick="alterar('${produto.produto._id}')" class="botao-alterar">alterar</button>
          <button class="botao-deletar" onclick="deletar('${produto.produto._id}')">Deletar</button>
        </div>
        </div>`;
              const criarProduto = document.getElementById("criar-produto");
              criarProduto.remove();
            }
          });
      }
      function deletar(id) {
        const deletar = prompt(
          `Tem certeza que deseja excluir esse produto, responda com "sim" ou "não"`
        );
        if (deletar.includes("sim")) {
          fetch(`/produto/${id}`, {
            method: "DELETE",
          }).then((response) => {
            if (response.ok) {
              const elemento = document.getElementById(id);
              elemento.remove();
              alert("produto deletado com sucesso");
            }
          });
        } else {
          alert("não foi possivel excluir o produto");
        }
      }
      function alterar(id) {
        const produtoASerAlterado = document.getElementById(id);

        produtoASerAlterado.innerHTML = `
       <div id="alterasao">
        Nome do produto: <input type="text" id="nomeDoProduto"><br>
        Ingredientes: <input type="text" id="ingredientesNovos"><br>
        Valor: <input type="text" id="valorNovo"><br>
        <button onclick="finalizarAltersao('${id}')">Finalizar</button>
        <button onclick="cancelarAlterasao('${id}')">Cancelar</button>
       </div>
       `;
      }
      function finalizarAltersao(id) {
        const nomeDoProduto = document
          .getElementById("nomeDoProduto")
          .value.trim();
        const ingredientes = document
          .getElementById("ingredientesNovos")
          .value.trim();
        const valor = document.getElementById("valorNovo").value.trim();

        const alterasao = {};
        if (nomeDoProduto) {
          alterasao.nomeProduto = nomeDoProduto;
        }
        if (ingredientes) {
          alterasao.ingredientes = ingredientes;
        }
        if (valor) {
          alterasao.valor = valor;
        }
        fetch(`/produto/${ultimoElemento}/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(alterasao),
        })
          .then((response) => response.json())
          .then((response) => {
            alert("produto alterado com sucesso");
            const elemento = document.getElementById(id);
            document.getElementById("alterasao").remove();
            elemento.innerHTML = `
          <button onclick="alterar('${response._id}')" class="alterar">alterar</button>
          <button class="botao-deletar" onclick="deletar('${response._id}')">Deletar</button>
          <h2 class="nomeProdutos">${response.nomeProduto}</h2>
          <div class="ingredientes">${response.ingredientes}</p>
          <div class="valor">R$ ${response.valor}</div>
        `;
          });
      }
    </script>
  </body>
</html>
